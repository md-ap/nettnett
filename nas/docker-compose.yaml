services:
  rclone-webhook:
    image: rclone/rclone:latest
    container_name: rclone-backblaze-sync
    restart: unless-stopped
    environment:
      - RCLONE_CONFIG=/config/rclone/rclone.conf
      - WEBHOOK_SECRET=${WEBHOOK_SECRET}
    volumes:
      - ./config:/config
      - ./data:/data
      - ./cache:/root/.cache/rclone
      - ./webhook.sh:/webhook.sh:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        apk add --no-cache socat
        echo "Webhook server ready on port 9222..."
        socat TCP-LISTEN:9222,reuseaddr,fork EXEC:"/bin/sh /webhook.sh"
    ports:
      - "9222:9222"

  # Named tunnel - reemplaza los 2 quick tunnels con 1 solo container
  # Los subdominios se configuran en Cloudflare Zero Trust dashboard:
  #   radio.radionettnettstream.com -> 192.168.1.102:8080
  #   sync.radionettnettstream.com  -> rclone-backblaze-sync:9222
  cloudflare-tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    depends_on:
      - rclone-webhook
